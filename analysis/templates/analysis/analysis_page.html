{# analysis/templates/analysis/analysis_page.html #}
{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load mathfilters %}

{% block title %}DataSage - Analysis Dashboard{% endblock %}

{% block content %}
{# Adiciona padding ao container principal desta p√°gina #}
<div class="container py-4">
    <h2 class="mb-4"> <i class="fas fa-tachometer-alt me-2"></i> Analysis Dashboard <small class="text-muted fs-5">- {{ filename }}</small></h2>

    <!-- Tab Navigation (Traduzida) -->
    <ul class="nav nav-tabs mb-3" id="analysisTab" role="tablist">
        <li class="nav-item" role="presentation"> <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-tab-pane" type="button" role="tab" aria-controls="overview-tab-pane" aria-selected="true"><i class="fas fa-eye me-1"></i> Overview</button> </li>
        <li class="nav-item" role="presentation"> <button class="nav-link" id="cleaning-tab" data-bs-toggle="tab" data-bs-target="#cleaning-tab-pane" type="button" role="tab" aria-controls="cleaning-tab-pane" aria-selected="false"><i class="fas fa-broom me-1"></i> Data Cleaning</button> </li>
        <li class="nav-item" role="presentation"> <button class="nav-link" id="ml-tab" data-bs-toggle="tab" data-bs-target="#ml-tab-pane" type="button" role="tab" aria-controls="ml-tab-pane" aria-selected="false"><i class="fas fa-cogs me-1"></i> Analysis & ML</button> </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="analysisTabContent">

        <!-- ==================== Overview Tab (Traduzida e com Padding) ==================== -->
        <div class="tab-pane fade show active p-3 p-md-4" id="overview-tab-pane" role="tabpanel" aria-labelledby="overview-tab" tabindex="0"> {# Adicionado Padding #}
            <h4 class="mb-3"><i class="fas fa-binoculars me-2"></i>Data Overview</h4>
            <!-- Stat Cards (Traduzidos) -->
            <div class="row mb-4 g-4">
                 <div class="col-lg-3 col-md-6 mb-3"> <div class="card stat-card h-100"> <div class="card-body text-center"> <h5 class="card-title"><i class="fas fa-list-ol me-1 text-info"></i> Rows</h5> <p class="card-text display-6">{{ num_rows|intcomma }}</p> </div> </div> </div>
                 <div class="col-lg-3 col-md-6 mb-3"> <div class="card stat-card h-100"> <div class="card-body text-center"> <h5 class="card-title"><i class="fas fa-columns me-1 text-info"></i> Columns</h5> <p class="card-text display-6">{{ num_cols }}</p> </div> </div> </div>
                 <div class="col-lg-3 col-md-6 mb-3"> <div class="card stat-card h-100"> <div class="card-body text-center"> <h5 class="card-title"><i class="fas fa-question-circle me-1 text-warning"></i> Missing Values</h5> <p class="card-text display-6">{{ missing_percentage }}%</p> </div> </div> </div>
                 <div class="col-lg-3 col-md-6 mb-3"> <div class="card stat-card h-100"> <div class="card-body text-center"> <h5 class="card-title"><i class="fas fa-copy me-1 text-danger"></i> Duplicate Rows</h5> <p class="card-text display-6">{{ duplicate_rows|intcomma }}</p> </div> </div> </div>
            </div>
            <!-- Sample Data Table (Traduzido) -->
            <h5 class="mt-4"><i class="fas fa-table me-2"></i>Data Sample (First 5 Rows)</h5>
            <div class="table-responsive mb-4 card">
                 {% if not is_empty %} <div class="card-body p-0"> {{ sample_data_html|safe }} </div>
                 {% else %} <div class="card-body"> <p class="text-warning mb-0">Data is empty.</p> </div> {% endif %}
            </div>

           <!-- Column Summaries (Traduzido) -->
            <hr class="my-4"> <h4 class="mt-4 mb-3"><i class="fas fa-list-ul me-2"></i>Column Summaries</h4> {% if not is_empty and column_details %} <div class="accordion" id="columnDetailsAccordion"> {% for col_name, details in column_details.items %} <div class="accordion-item"> <h2 class="accordion-header" id="heading-{{ forloop.counter }}"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse-{{ forloop.counter }}"> <span class="fw-bold me-2">{{ details.name }}</span> <span class="badge rounded-pill me-2 {% if details.type == 'Numeric' %}bg-info{% else %}bg-primary{% endif %} text-dark">{{ details.type }}</span> {% if details.missing_pct > 0 %} <span class="badge rounded-pill bg-warning text-dark">Missing: {{ details.missing_pct|floatformat:1 }}%</span> {% endif %} </button> </h2> <div id="collapse-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ forloop.counter }}" data-bs-parent="#columnDetailsAccordion"> <div class="accordion-body"> <div class="row"> <div class="col-md-6 mb-3 mb-md-0"> <h6 class="text-info"><i class="fas fa-calculator me-2"></i>Statistics</h6> <table class="table table-sm table-dark table-borderless table-striped small"> <tbody> <tr><th scope="row">Missing Values</th><td>{{ details.missing|intcomma }} ({{ details.missing_pct|floatformat:1 }}%)</td></tr> <tr><th scope="row">Unique Values</th><td>{{ details.unique_count|intcomma }}</td></tr> {% if details.type == 'Numeric' %} <tr><th scope="row">Mean</th><td>{{ details.mean|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">Median</th><td>{{ details.median|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">Std Dev</th><td>{{ details.std|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">Min</th><td>{{ details.min|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">Max</th><td>{{ details.max|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">IQR</th><td>{{ details.iqr|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">Skewness</th><td>{{ details.skew|floatformat:3|default:"N/A" }}</td></tr> <tr><th scope="row">Kurtosis</th><td>{{ details.kurt|floatformat:3|default:"N/A" }}</td></tr> {% else %} <tr><th scope="row">Count</th><td>{{ details.count|intcomma|default:num_rows|sub:details.missing|intcomma }}</td></tr> <tr><th scope="row">Mode</th><td>{{ details.top|default:"N/A" }}</td></tr> <tr><th scope="row">Mode Freq.</th><td>{{ details.freq|intcomma|default:"N/A" }}</td></tr> {% endif %} </tbody> </table> </div> <div class="col-md-6"> <h6 class="text-info"><i class="fas fa-chart-bar me-2"></i>Visualizations</h6> <div class="text-center border rounded border-secondary p-3" style="min-height: 200px;"> <div class="univariate-plot-container mb-3" id="plot-container-{{ details.name|slugify }}"> <small class="text-muted">Click button below to generate plot(s).</small> </div> <button class="btn btn-sm btn-outline-info generate-univariate-plot-btn" data-column="{{ details.name }}" data-target-container="#plot-container-{{ details.name|slugify }}"> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-chart-bar me-1"></i> Generate Plot </button> <div class="univariate-plot-feedback small text-danger mt-2" style="display: none;"></div> </div> </div> </div> </div> </div> </div> {% endfor %} </div> {% elif is_empty %} <p class="text-warning">Data is empty. No column details available.</p> {% else %} <p class="text-danger">Could not load column details.</p> {% endif %}

            <!-- Correlation Section (Traduzido) -->
            <hr class="my-4"> <div class="card mb-4"> <div class="card-header"><i class="fas fa-link me-2"></i>Correlation Analysis</div> <div class="card-body"> <p class="text-muted small">Select numeric columns to visualize correlations.</p> {% csrf_token %} <div class="mb-3"> <label class="form-label">Select Columns:</label> <div class="mb-2"> {% for col in numeric_columns %} <div class="form-check form-check-inline"> <input class="form-check-input" type="checkbox" name="corr_columns" value="{{ col }}" id="corr_{{ forloop.counter }}"> <label class="form-check-label" for="corr_{{ forloop.counter }}">{{ col }}</label> </div> {% empty %} <p class="text-muted small">No numeric columns.</p> {% endfor %} </div> <button type="button" id="calculate-corr-btn-ajax" class="btn btn-primary mt-2" {% if not numeric_columns %}disabled{% endif %}> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-calculator me-1"></i> Show Correlation </button> </div> <div id="correlation-feedback" class="mt-2"></div> <div id="correlation-chart-container" class="mt-3 text-center p-2 border rounded" style="min-height: 300px; background-color: var(--primary);"> <p class="text-center p-5 text-muted">Select columns and click button.</p> </div> </div> </div>

            <!-- Scatter Plot Section (Traduzido) -->
            <div class="card mb-4"> <div class="card-header"><i class="fas fa-project-diagram me-2"></i>Scatter Plot Analysis</div> <div class="card-body"> <p class="text-muted small">Explore relationship between two numeric variables.</p> <div class="row g-3 align-items-end"> <div class="col-md-5"> <label for="scatter-x-axis" class="form-label">X-Axis:</label> <select class="form-select form-select-sm" id="scatter-x-axis" name="scatter_x"> <option value="" selected disabled>-- Choose --</option> {% for col in numeric_columns %}<option value="{{ col }}">{{ col }}</option>{% empty %}<option value="" disabled>No numeric</option>{% endfor %} </select> </div> <div class="col-md-5"> <label for="scatter-y-axis" class="form-label">Y-Axis:</label> <select class="form-select form-select-sm" id="scatter-y-axis" name="scatter_y"> <option value="" selected disabled>-- Choose --</option> {% for col in numeric_columns %}<option value="{{ col }}">{{ col }}</option>{% empty %}<option value="" disabled>No numeric</option>{% endfor %} </select> </div> <div class="col-md-2"> <button type="button" id="generate-scatter-btn" class="btn btn-primary w-100 btn-sm" {% if not numeric_columns %}disabled{% endif %}> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-search-plus me-1"></i> Show Plot </button> </div> </div> <div id="scatter-feedback" class="mt-2"></div> <div id="scatter-chart-container" class="mt-3 text-center p-2 border rounded" style="min-height: 350px; background-color: var(--primary);"> <p class="text-center p-5 text-muted">Select X and Y variables and click button.</p> </div> </div> </div>

            <div class="mt-4 text-center"> <a href="#" class="btn btn-outline-secondary disabled"><i class="fas fa-download me-1"></i> Download Original Dataset</a> </div>
        </div>{# Fim da Overview Tab Pane #}


        <!-- ==================== Data Cleaning Tab (Traduzida e com Padding) ==================== -->
        <div class="tab-pane fade p-3 p-md-4" id="cleaning-tab-pane" role="tabpanel" aria-labelledby="cleaning-tab" tabindex="0"> {# Adicionado Padding #}
            <div class="row">
                <div class="col-md-8"> {# Coluna Principal de Limpeza #}
                    <h4 class="mb-3"><i class="fas fa-broom me-2"></i>Data Cleaning Operations</h4>
                    <!-- Missing Values Card (Traduzido) --> <div class="card cleaning-option mb-4"> <div class="card-header fw-bold"><i class="fas fa-question-circle me-2"></i>1. Handle Missing Values</div> <div class="card-body"> <div class="mb-3"> <label for="missing-value-strategy" class="form-label">Strategy:</label> <select class="form-select" id="missing-value-strategy" name="missing_strategy"> <option value="none" selected>Do Nothing</option> <option value="remove_rows">Remove Rows with Missing</option> <option value="fill_mean">Fill Numeric with Mean</option> <option value="fill_median">Fill Numeric with Median</option> <option value="fill_mode">Fill Categorical with Mode</option> <option value="fill_constant">Fill All with Constant</option> </select> </div> <div class="mb-3" id="constant-value-input-container" style="display: none;"> <label for="missing-value-constant" class="form-label">Constant Value:</label> <input type="text" class="form-control" id="missing-value-constant" name="missing_constant_value" placeholder="e.g., 0 or Unknown"> </div> </div> </div>
                    <!-- Duplicates Card (Traduzido) --> <div class="card cleaning-option mb-4"> <div class="card-header fw-bold"><i class="fas fa-copy me-2"></i>2. Handle Duplicates</div> <div class="card-body"> <div class="form-check"> <input class="form-check-input" type="checkbox" value="true" id="remove-duplicates-checkbox" name="remove_duplicates"> <label class="form-check-label" for="remove-duplicates-checkbox">Remove duplicate rows</label> </div> </div> </div>
                    <!-- Handle Outliers Card (Traduzido) --> <div class="card cleaning-option mb-4"> <div class="card-header fw-bold"><i class="fas fa-skull-crossbones me-2"></i>3. Handle Outliers</div> <div class="card-body"> <p class="text-muted small">Uses IQR method for numeric columns.</p> <div class="mb-3"> <label class="form-label">Select Numeric Columns:</label> <div id="outlier-column-selection" class="border rounded p-2" style="max-height: 150px; overflow-y: auto; background-color: var(--primary);"> {% for col in numeric_columns %} <div class="form-check"> <input class="form-check-input outlier-column-checkbox" type="checkbox" value="{{ col }}" id="outlier_col_{{ forloop.counter }}"> <label class="form-check-label small" for="outlier_col_{{ forloop.counter }}">{{ col }}</label> </div> {% empty %} <p class="text-muted small mb-0">No numeric columns.</p> {% endfor %} </div> </div> <div class="mb-3"> <label for="outlier-iqr-multiplier" class="form-label">IQR Multiplier:</label> <input type="number" class="form-control form-control-sm" id="outlier-iqr-multiplier" value="1.5" step="0.1"> <small class="text-muted">Commonly 1.5 or 3.</small> </div> <div class="mb-3"> <label class="form-label">Action:</label> <div> <button type="button" id="detect-outliers-btn" class="btn btn-sm btn-warning me-2"> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-search me-1"></i> Detect </button> <button type="button" id="cap-outliers-btn" class="btn btn-sm btn-danger"> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-compress-alt me-1"></i> Cap (Apply) </button> </div> <small class="text-muted d-block mt-1">'Cap' replaces outliers and saves.</small> </div> <div id="outlier-results-container" class="mt-3" style="display: none;"> <h6 class="text-info">Outlier Results:</h6> <div id="outlier-results-content" class="small border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: var(--primary);"></div> </div> </div> </div>
                    <!-- Feedback Geral e Bot√£o Apply Final (Traduzido) --> <div id="cleaning-feedback" class="mt-3 mb-3"></div> <div class="mt-4 border-top pt-4 border-secondary"> <h5 class="mb-3">Apply General Cleaning</h5> <p class="text-muted small">Applies steps 1 (Missing) and 2 (Duplicates). Outlier capping applies via its own button.</p> <div class="d-flex flex-wrap gap-2"> <button type="button" id="apply-cleaning-btn" class="btn btn-success btn-lg"> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-check-circle me-1"></i> Apply Missing/Duplicates </button> <a href="#" id="download-cleaned-btn" class="btn btn-outline-info disabled" role="button" aria-disabled="true" download> <i class="fas fa-download me-1"></i> Download Current Data </a> <a href="{% url 'analysis:home' %}" class="btn btn-outline-secondary"> <i class="fas fa-arrow-left me-1"></i> Back to Upload </a> </div> </div>
                </div>{# Fim Coluna Principal #}
                <div class="col-md-4"> {# Coluna de Status Lateral (Traduzido) #} <div class="card sticky-top" style="top: 20px;"> <div class="card-header fw-bold"><i class="fas fa-info-circle me-1"></i> Status</div> <div class="card-body small"> <p><strong>Current Data:</strong> <br><small id="current-data-filename" class="text-break">{{ filename }}</small></p> <hr> <div id="cleaning-status-info"> <p class="text-muted">No general cleaning applied.</p> </div> <hr> <div id="outlier-status-info"> <p class="text-muted">No outlier actions performed.</p> </div> </div> </div> </div>{# Fim Coluna de Status #}
            </div>{# Fim Row #}
        </div>{# Fim da Cleaning Tab Pane #}


        <!-- ==================== Analysis & ML Tab (Traduzida e com Padding) ==================== -->
        <div class="tab-pane fade p-3 p-md-4" id="ml-tab-pane" role="tabpanel" aria-labelledby="ml-tab" tabindex="0"> {# Adicionado Padding #}
            <h4 class="mb-3"><i class="fas fa-cogs me-2"></i>Model Training & Evaluation</h4>
            <p class="text-muted">Select target, model(s), configure, train, compare, and download pipelines.</p>
            <div class="row mt-4">
                <div class="col-md-7"> <!-- Coluna Configura√ß√£o -->
                    <!-- Select Target (Traduzido) --> <div class="card mb-4"> <div class="card-header fw-bold"><i class="fas fa-bullseye me-1"></i> 1. Select Target Variable (Y)</div> <div class="card-body"> <label for="target-variable-select" class="form-label">Column to predict:</label> <select class="form-select" id="target-variable-select" name="target_variable" required> <option value="" selected disabled>-- Select Target --</option> {% for col in columns %} <option value="{{ col }}">{{ col }}</option> {% empty %} <option value="" disabled>No columns</option> {% endfor %} </select> </div> </div>
                    <!-- Select Models (Traduzido) --> <div class="card mb-4"> <div class="card-header fw-bold"><i class="fas fa-brain me-1"></i> 2. Select Model(s)</div> <div class="card-body"> <p class="mb-2">Check the algorithm(s) to train:</p> <div id="model-selection-list-multiple" class="border rounded p-2" style="max-height: 250px; overflow-y: auto; background-color: var(--primary);"> <div class="list-group list-group-flush"> <label class="list-group-item bg-transparent text-light border-0 py-1 px-2"><input class="form-check-input me-2 model-checkbox" type="checkbox" name="selected_models" value="LinearRegression"> Linear Regression <span class="badge bg-info float-end">R</span></label> <label class="list-group-item bg-transparent text-light border-0 py-1 px-2"><input class="form-check-input me-2 model-checkbox" type="checkbox" name="selected_models" value="LogisticRegression"> Logistic Regression <span class="badge bg-primary float-end">C</span></label> <label class="list-group-item bg-transparent text-light border-0 py-1 px-2"><input class="form-check-input me-2 model-checkbox" type="checkbox" name="selected_models" value="DecisionTree"> Decision Tree <span class="badge bg-primary float-end">C</span><span class="badge bg-info float-end me-1">R</span></label> <label class="list-group-item bg-transparent text-light border-0 py-1 px-2"><input class="form-check-input me-2 model-checkbox" type="checkbox" name="selected_models" value="RandomForest"> Random Forest <span class="badge bg-primary float-end">C</span><span class="badge bg-info float-end me-1">R</span></label> <label class="list-group-item bg-transparent text-light border-0 py-1 px-2"><input class="form-check-input me-2 model-checkbox" type="checkbox" name="selected_models" value="SVM"> SVM <span class="badge bg-primary float-end">C</span></label> <label class="list-group-item bg-transparent text-light border-0 py-1 px-2"><input class="form-check-input me-2 model-checkbox" type="checkbox" name="selected_models" value="KNN"> KNN <span class="badge bg-primary float-end">C</span></label> </div> </div> <small class="text-muted mt-2 d-block"> <span class="badge bg-info">R</span>=Regression | <span class="badge bg-primary">C</span>=Classification</small> </div> </div>
                    <!-- Configura√ß√£o (Traduzido) --> <div class="card mb-4"> <div class="card-header fw-bold"><i class="fas fa-sliders-h me-1"></i> 3. Training Configuration</div> <div class="card-body"> <div class="mb-3"> <label for="train-test-split-ratio" class="form-label">Test Set Size:</label> <select class="form-select form-select-sm" id="train-test-split-ratio" name="test_size"> <option value="0.2" selected>20%</option> <option value="0.25">25%</option> <option value="0.3">30%</option> <option value="0.33">33%</option> </select> <small class="text-muted d-block mt-1">Data percentage for testing.</small> </div> </div> </div>
                    <!-- Treino e Feedback (Traduzido) --> <div id="training-feedback" class="mt-3 mb-3"></div> <div class="mt-4 mb-5"> <button type="button" id="train-multiple-models-btn" class="btn btn-primary btn-lg me-2"> <span class="spinner-border spinner-border-sm me-1" style="display: none;"></span> <i class="fas fa-play-circle me-1"></i> Train Selected Models </button> </div>
                </div>
                <div class="col-md-5"> <!-- Coluna Resultados (Traduzido) --> <div class="card sticky-top" style="top: 20px;"> <div class="card-header fw-bold"><i class="fas fa-chart-line me-1"></i> Model Comparison Results</div> <div class="card-body" id="model-results-container" style="min-height: 400px; max-height: 80vh; overflow-y: auto;"> <p class="text-center text-muted p-5">Select options and click "Train Selected Models".</p> </div> </div> </div>
            </div>
        </div>{# Fim da ML Tab Pane #}

    </div> <!-- Fim do Tab Content -->

    {# --- Footer Simples para P√°ginas Internas --- #}
    <footer class="mt-5 py-3 text-center text-muted border-top border-secondary">
        <small>¬© {% now "Y" %} DataSage by Leonardo Moraes</small>
    </footer>
    {# --- Fim Footer Simples --- #}

</div> {# Fim do Container Principal da P√°gina #}
{% endblock content %}


{% block extra_scripts %}
{# --- SEU JAVASCRIPT COMPLETO AQUI --- #}
<script>
// Copie e cole aqui o conte√∫do completo do seu bloco <script> anterior,
// pois nenhuma mudan√ßa funcional foi feita no JS, apenas no HTML/CSS.
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value; if (!csrfToken) { console.error('CSRF Token not found!'); return; }
    try { const urlParams = new URLSearchParams(window.location.search); const activeTabId = urlParams.get('tab'); if (activeTabId) { const tabElement = document.querySelector(`#${activeTabId}-tab`); if (tabElement && typeof bootstrap !== 'undefined' && bootstrap.Tab) { new bootstrap.Tab(tabElement).show(); } } } catch(e) { console.error("Error handling URL tab:", e); }
    const feedbackDivCorr = document.getElementById('correlation-feedback'); const chartContainerCorr = document.getElementById('correlation-chart-container'); const corrCheckboxes = document.querySelectorAll('input[name="corr_columns"]'); const corrButton = document.getElementById('calculate-corr-btn-ajax'); const corrSpinner = corrButton?.querySelector('.spinner-border');
    const scatterXSelect = document.getElementById('scatter-x-axis'); const scatterYSelect = document.getElementById('scatter-y-axis'); const scatterBtn = document.getElementById('generate-scatter-btn'); const scatterFeedbackDiv = document.getElementById('scatter-feedback'); const scatterChartContainer = document.getElementById('scatter-chart-container'); const scatterSpinner = scatterBtn?.querySelector('.spinner-border');
    const missingValueSelect = document.getElementById('missing-value-strategy'); const constantValueContainer = document.getElementById('constant-value-input-container'); const constantValueInput = document.getElementById('missing-value-constant'); const removeDuplicatesCheckbox = document.getElementById('remove-duplicates-checkbox'); const applyCleaningBtn = document.getElementById('apply-cleaning-btn'); const cleaningFeedbackDiv = document.getElementById('cleaning-feedback'); const downloadCleanedBtn = document.getElementById('download-cleaned-btn'); const cleaningSpinner = applyCleaningBtn?.querySelector('.spinner-border'); const cleaningStatusInfo = document.getElementById('cleaning-status-info'); const currentDataFilenameSpan = document.getElementById('current-data-filename');
    const outlierCheckboxes = document.querySelectorAll('.outlier-column-checkbox'); const iqrMultiplierInput = document.getElementById('outlier-iqr-multiplier'); const detectOutliersBtn = document.getElementById('detect-outliers-btn'); const capOutliersBtn = document.getElementById('cap-outliers-btn'); const outlierResultsContainer = document.getElementById('outlier-results-container'); const outlierResultsContent = document.getElementById('outlier-results-content'); const outlierStatusInfo = document.getElementById('outlier-status-info'); const detectSpinner = detectOutliersBtn?.querySelector('.spinner-border'); const capSpinner = capOutliersBtn?.querySelector('.spinner-border');
    const targetSelect = document.getElementById('target-variable-select'); const modelCheckboxes = document.querySelectorAll('.model-checkbox'); const testSizeSelect = document.getElementById('train-test-split-ratio'); const trainMultipleBtn = document.getElementById('train-multiple-models-btn'); const trainingFeedbackDiv = document.getElementById('training-feedback'); const resultsContainer = document.getElementById('model-results-container'); const trainMultipleSpinner = trainMultipleBtn?.querySelector('.spinner-border');
    function showFeedback(div, message, type = 'info', autoDismiss = true) { if (!div) return; div.className = `alert alert-${type} alert-dismissible fade show`; div.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`; div.style.display = 'block'; if (autoDismiss && type !== 'danger') { setTimeout(() => { if (div.parentElement) { try { bootstrap.Alert.getOrCreateInstance(div).close(); } catch(e){ /* ignore */ } } }, 5000); } }
    function showLoading(container, message = "Loading...") { if (!container) return; container.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 p-5"><div class="spinner-border text-info me-2" role="status"></div><span>${message}</span></div>`; }
    function clearMlFeedbackAndResults() { if(trainingFeedbackDiv) trainingFeedbackDiv.style.display = 'none'; if(resultsContainer) resultsContainer.innerHTML = '<p class="text-center text-muted p-5">Select options and click "Train Selected Models".</p>'; }
    function renderOutlierResults(resultsData, action) { if (!outlierResultsContent) return; let contentHtml = `<ul class="list-unstyled mb-0">`; let totalOutliers = 0; let totalCapped = 0; if (Object.keys(resultsData).length === 0) { contentHtml += `<li>No numeric columns processed.</li>`; } else { for (const colName in resultsData) { const info = resultsData[colName]; totalOutliers += info.count; totalCapped += info.rows_capped; contentHtml += `<li><strong>${colName}:</strong> ${info.count} outliers (${info.percentage}%)`; if (info.count > 0) { contentHtml += ` <small class="text-muted">[Bounds: ${info.lower_bound} - ${info.upper_bound}]</small>`; } if (action === 'cap' && info.rows_capped > 0) { contentHtml += ` <span class="text-success">(${info.rows_capped} capped)</span>`; } contentHtml += `</li>`; } } contentHtml += `</ul>`; const multiplier = iqrMultiplierInput ? iqrMultiplierInput.value : 'default'; if (action === 'detect') { if (totalOutliers > 0) { showFeedback(cleaningFeedbackDiv, `Detected ${totalOutliers} potential outliers (IQR x${multiplier}).`, 'warning', false); } else { showFeedback(cleaningFeedbackDiv, `No outliers detected (IQR x${multiplier}).`, 'success'); } } else if (action === 'cap') { if (totalCapped > 0) { showFeedback(cleaningFeedbackDiv, `Capped ${totalCapped} outliers (IQR x${multiplier}). Dataset updated.`, 'success'); if(outlierStatusInfo) outlierStatusInfo.innerHTML = `<p class="text-success small">Outliers capped (IQR x${multiplier}).</p>`; } else { showFeedback(cleaningFeedbackDiv, `No outliers needed capping.`, 'info'); if(outlierStatusInfo) outlierStatusInfo.innerHTML = `<p class="text-info small">No outliers found to cap.</p>`; } } outlierResultsContent.innerHTML = contentHtml; if(outlierResultsContainer) outlierResultsContainer.style.display = 'block'; }
    function handleOutlierAction(action) { const selectedColumns = Array.from(outlierCheckboxes).filter(cb => cb.checked).map(cb => cb.value); const iqrMultiplier = parseFloat(iqrMultiplierInput.value); if (selectedColumns.length === 0) { showFeedback(cleaningFeedbackDiv, 'Select numeric column(s).', 'warning'); return; } if (isNaN(iqrMultiplier) || iqrMultiplier <= 0) { showFeedback(cleaningFeedbackDiv, 'Enter valid IQR multiplier.', 'warning'); return; } const currentSpinner = (action === 'detect') ? detectSpinner : capSpinner; detectOutliersBtn.disabled = true; capOutliersBtn.disabled = true; if(currentSpinner) currentSpinner.style.display = 'inline-block'; if(cleaningFeedbackDiv) cleaningFeedbackDiv.style.display = 'none'; if(outlierResultsContainer) outlierResultsContainer.style.display = 'none'; fetch("{% url 'analysis:ajax_handle_outliers' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ columns: selectedColumns, action: action, method: 'iqr', iqr_multiplier: iqrMultiplier }) }) .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) .then(data => { if (data.status === 'success') { renderOutlierResults(data.outlier_info, action); if (action === 'cap' && data.download_url && downloadCleanedBtn) { downloadCleanedBtn.href = data.download_url; downloadCleanedBtn.classList.remove('disabled'); downloadCleanedBtn.setAttribute('aria-disabled', 'false'); if (data.new_filename) { downloadCleanedBtn.download = data.new_filename; } if (currentDataFilenameSpan && data.new_filename) { currentDataFilenameSpan.textContent = data.new_filename; } } } else { throw new Error(data.error || `Failed to ${action} outliers.`); } }) .catch(error => { console.error(`Outlier ${action} Error:`, error); showFeedback(cleaningFeedbackDiv, `Error: ${error.error || error.message || 'Operation failed.'}`, 'danger', false); }) .finally(() => { if(currentSpinner) currentSpinner.style.display = 'none'; detectOutliersBtn.disabled = false; capOutliersBtn.disabled = false; }); }
    function renderComparisonResults(resultsData, targetVar, problemType) { if (!resultsContainer) return; let tableHtml = `<h5 class="mb-3">Model Comparison (Target: ${targetVar || 'N/A'})</h5><div class="table-responsive"><table class="table table-sm table-dark table-striped table-hover small"><thead><tr><th>Model</th><th>Status</th>`; if (problemType === 'classification') { tableHtml += `<th>Accuracy</th><th>Precision</th><th>Recall</th><th>F1-Score</th><th>AUC</th>`; } else if (problemType === 'regression') { tableHtml += `<th>R¬≤ Score</th><th>RMSE</th><th>MSE</th>`; } tableHtml += `<th>Actions</th></tr></thead><tbody>`; if (!resultsData || Object.keys(resultsData).length === 0) { tableHtml += `<tr><td colspan="8" class="text-center text-muted">No models returned results.</td></tr>`; } else { for (const modelName in resultsData) { const result = resultsData[modelName]; tableHtml += `<tr><td>${modelName}</td>`; let statusBadge = ''; if (result.status === 'Success') statusBadge = `<span class="badge bg-success">Success</span>`; else if (result.status === 'Failed') statusBadge = `<span class="badge bg-danger" title="${result.error || ''}">Failed</span>`; else statusBadge = `<span class="badge bg-secondary">${result.status}</span>`; tableHtml += `<td>${statusBadge}</td>`; const metrics = result.metrics || {}; if (problemType === 'classification') { tableHtml += `<td>${metrics.accuracy?.toFixed(4) ?? 'N/A'}</td><td>${metrics.precision?.toFixed(4) ?? 'N/A'}</td><td>${metrics.recall?.toFixed(4) ?? 'N/A'}</td><td>${metrics.f1_score?.toFixed(4) ?? 'N/A'}</td><td>${metrics.roc_auc?.toFixed(4) ?? 'N/A'}</td>`; } else if (problemType === 'regression') { tableHtml += `<td>${metrics.r2_score?.toFixed(4) ?? 'N/A'}</td><td>${metrics.rmse?.toFixed(4) ?? 'N/A'}</td><td>${metrics.mean_squared_error?.toFixed(4) ?? 'N/A'}</td>`; } tableHtml += `<td>`; if (result.status === 'Success' && result.download_url) { tableHtml += `<a href="${result.download_url}" class="btn btn-xs btn-outline-light py-0 px-1" download="${result.pipeline_filename || 'pipeline.joblib'}" title="Download Pipeline (.joblib)"><i class="fas fa-download fa-xs"></i></a>`; } else if (result.status === 'Failed' && result.error) { tableHtml += `<i class="fas fa-exclamation-triangle text-danger" title="${result.error}"></i>`; } else { tableHtml += `-`; } tableHtml += `</td></tr>`; } } tableHtml += `</tbody></table></div>`; resultsContainer.innerHTML = tableHtml; }
    if (corrButton && csrfToken) { corrButton.addEventListener('click', () => { const selectedColumns = Array.from(corrCheckboxes).filter(cb => cb.checked).map(cb => cb.value); if (selectedColumns.length < 2) { showFeedback(feedbackDivCorr, 'Select at least two numeric columns.', 'warning'); return; } showLoading(chartContainerCorr, 'Generating plot...'); if(feedbackDivCorr) feedbackDivCorr.style.display = 'none'; corrButton.disabled = true; if(corrSpinner) corrSpinner.style.display = 'inline-block'; fetch("{% url 'analysis:ajax_get_correlation' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ selected_columns: selectedColumns }) }) .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) .then(data => { if (data.status === 'success' && data.image_url) { chartContainerCorr.innerHTML = `<img src="${data.image_url}?v=${new Date().getTime()}" alt="Correlation Heatmap" class="img-fluid">`; if(feedbackDivCorr) feedbackDivCorr.style.display = 'none'; } else { throw new Error(data.error || 'Failed to generate plot.'); } }) .catch(error => { console.error('Correlation Error:', error); showFeedback(feedbackDivCorr, `Error: ${error.error || error.message || 'Could not generate plot.'}`, 'danger', false); chartContainerCorr.innerHTML = '<p class="text-center p-5 text-danger">Failed to load plot.</p>'; }) .finally(() => { corrButton.disabled = false; if(corrSpinner) corrSpinner.style.display = 'none'; }); }); }
    if (scatterBtn && csrfToken) { scatterBtn.addEventListener('click', () => { const xCol = scatterXSelect.value; const yCol = scatterYSelect.value; if (!xCol || !yCol) { showFeedback(scatterFeedbackDiv, 'Select both X and Y axes.', 'warning'); return; } if (xCol === yCol) { showFeedback(scatterFeedbackDiv, 'X and Y axes cannot be the same.', 'warning'); return; } showLoading(scatterChartContainer, 'Generating plot...'); if(scatterFeedbackDiv) scatterFeedbackDiv.style.display = 'none'; scatterBtn.disabled = true; if(scatterSpinner) scatterSpinner.style.display = 'inline-block'; fetch("{% url 'analysis:ajax_get_scatter_plot' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ x_column: xCol, y_column: yCol }) }) .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) .then(data => { if (data.status === 'success' && data.image_url) { scatterChartContainer.innerHTML = `<img src="${data.image_url}?v=${new Date().getTime()}" alt="Scatter plot of ${yCol} vs ${xCol}" class="img-fluid">`; if(scatterFeedbackDiv) scatterFeedbackDiv.style.display = 'none'; } else { throw new Error(data.error || 'Failed to generate plot.'); } }) .catch(error => { console.error('Scatter Plot Error:', error); showFeedback(scatterFeedbackDiv, `Error: ${error.error || error.message || 'Could not generate plot.'}`, 'danger', false); scatterChartContainer.innerHTML = '<p class="text-center p-5 text-danger">Failed to load plot.</p>'; }) .finally(() => { scatterBtn.disabled = false; if(scatterSpinner) scatterSpinner.style.display = 'none'; }); }); }
    const univariatePlotButtons = document.querySelectorAll('.generate-univariate-plot-btn'); univariatePlotButtons.forEach(button => { button.addEventListener('click', function() { const columnName = this.dataset.column; const targetContainerSelector = this.dataset.targetContainer; const plotContainer = document.querySelector(targetContainerSelector); const feedbackContainer = plotContainer?.parentElement.querySelector('.univariate-plot-feedback'); const btnSpinner = this.querySelector('.spinner-border'); if (!columnName || !plotContainer) { console.error('Missing config for univariate plot.'); return; } showLoading(plotContainer, 'Generating...'); if(feedbackContainer) feedbackContainer.style.display = 'none'; this.disabled = true; if(btnSpinner) btnSpinner.style.display = 'inline-block'; fetch("{% url 'analysis:ajax_get_univariate_plot' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ column_name: columnName }) }) .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) .then(data => { if (data.status === 'success' && data.image_urls) { plotContainer.innerHTML = ''; const timestamp = new Date().getTime(); for (const plotType in data.image_urls) { if (data.image_urls.hasOwnProperty(plotType) && data.image_urls[plotType]) { const img = document.createElement('img'); img.src = `${data.image_urls[plotType]}?v=${timestamp}`; img.alt = `${plotType.charAt(0).toUpperCase() + plotType.slice(1)} plot for ${data.column}`; img.classList.add('img-fluid', 'mb-2', 'border', 'rounded'); plotContainer.appendChild(img); } } } else { throw new Error(data.error || `Failed to generate plot for ${columnName}.`); } }) .catch(error => { console.error(`Univariate Plot Error for ${columnName}:`, error); plotContainer.innerHTML = `<small class="text-danger">Error loading plot.</small>`; if(feedbackContainer) { feedbackContainer.textContent = `Error: ${error.error || error.message || 'Could not generate plot.'}`; feedbackContainer.style.display = 'block'; } this.disabled = false; }) .finally(() => { if(btnSpinner) btnSpinner.style.display = 'none'; /* Keep disabled? this.disabled = false; */ }); }); });
    if (missingValueSelect && constantValueContainer) { missingValueSelect.addEventListener('change', function() { constantValueContainer.style.display = (this.value === 'fill_constant') ? 'block' : 'none'; if (this.value !== 'fill_constant' && constantValueInput) constantValueInput.value = ''; }); constantValueContainer.style.display = (missingValueSelect.value === 'fill_constant') ? 'block' : 'none'; }
    if (applyCleaningBtn && csrfToken) { applyCleaningBtn.addEventListener('click', () => { const missingStrategy = missingValueSelect.value; const removeDuplicates = removeDuplicatesCheckbox.checked; let constantValue = null; if (missingStrategy === 'fill_constant') { constantValue = constantValueInput.value; if (constantValue === null || constantValue.trim() === '') { showFeedback(cleaningFeedbackDiv, 'Enter constant value.', 'warning'); return; } } if (missingStrategy === 'none' && !removeDuplicates) { showFeedback(cleaningFeedbackDiv, 'No Missing/Duplicate operation selected.', 'info'); return; } if(cleaningSpinner) cleaningSpinner.style.display = 'inline-block'; applyCleaningBtn.disabled = true; if(downloadCleanedBtn) downloadCleanedBtn.classList.add('disabled'); if(cleaningFeedbackDiv) cleaningFeedbackDiv.style.display = 'none'; showFeedback(cleaningFeedbackDiv, 'Applying cleaning...', 'info'); fetch("{% url 'analysis:ajax_apply_cleaning' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ missing_strategy: missingStrategy, remove_duplicates: removeDuplicates, missing_constant_value: constantValue }) }) .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) .then(data => { if (data.status === 'success') { showFeedback(cleaningFeedbackDiv, data.message || 'Cleaning applied!', 'success'); if (data.download_url && downloadCleanedBtn) { downloadCleanedBtn.href = data.download_url; downloadCleanedBtn.classList.remove('disabled'); downloadCleanedBtn.setAttribute('aria-disabled', 'false'); if (data.cleaned_filename) { downloadCleanedBtn.download = data.cleaned_filename; } } else if(downloadCleanedBtn) { downloadCleanedBtn.classList.add('disabled'); } if (cleaningStatusInfo) { cleaningStatusInfo.innerHTML = `<p class="text-success small">Missing/Duplicate handling applied (${data.rows_removed || 0} rows affected).</p><p>Using: <strong>${data.new_filename || 'Cleaned data'}</strong></p>`; } if (currentDataFilenameSpan && data.new_filename){ currentDataFilenameSpan.textContent = data.new_filename; } } else { throw new Error(data.error || 'Failed to apply cleaning.'); } }) .catch(error => { console.error('Cleaning Error:', error); showFeedback(cleaningFeedbackDiv, `Error: ${error.error || error.message || 'Could not apply cleaning.'}`, 'danger', false); if(downloadCleanedBtn) downloadCleanedBtn.classList.add('disabled'); }) .finally(() => { if(cleaningSpinner) cleaningSpinner.style.display = 'none'; applyCleaningBtn.disabled = false; }); }); }
    if (detectOutliersBtn) { detectOutliersBtn.addEventListener('click', () => handleOutlierAction('detect')); }
    if (capOutliersBtn) { capOutliersBtn.addEventListener('click', () => handleOutlierAction('cap')); }
    if (targetSelect) { targetSelect.addEventListener('change', clearMlFeedbackAndResults); }
    modelCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', clearMlFeedbackAndResults); });
    if (trainMultipleBtn && csrfToken) { trainMultipleBtn.addEventListener('click', () => { const targetVariable = targetSelect.value; const testSize = testSizeSelect.value; const selectedModels = Array.from(modelCheckboxes).filter(cb => cb.checked).map(cb => cb.value); if (!targetVariable) { showFeedback(trainingFeedbackDiv, 'Select a target variable.', 'warning'); return; } if (selectedModels.length === 0) { showFeedback(trainingFeedbackDiv, 'Select at least one model.', 'warning'); return; } if(trainMultipleSpinner) trainMultipleSpinner.style.display = 'inline-block'; trainMultipleBtn.disabled = true; clearMlFeedbackAndResults(); showFeedback(trainingFeedbackDiv, `Training ${selectedModels.length} model(s)...`, 'info'); showLoading(resultsContainer, "Training models..."); fetch("{% url 'analysis:ajax_train_multiple_models' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ target_variable: targetVariable, selected_models: selectedModels, test_size: testSize }) }) .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err))) .then(data => { if (data.status === 'success' && data.results) { showFeedback(trainingFeedbackDiv, data.message || 'Training finished!', 'success'); renderComparisonResults(data.results, data.target_variable, data.problem_type); } else { throw new Error(data.error || 'No results returned.'); } }) .catch(error => { console.error("Multiple Training Error:", error); const errorMessage = error.error || (error instanceof Error ? error.message : 'Unknown error.'); showFeedback(trainingFeedbackDiv, `Training failed: ${errorMessage}`, 'danger', false); resultsContainer.innerHTML = '<p class="text-danger p-5 text-center">Training failed. Check logs.</p>'; }) .finally(() => { if(trainMultipleSpinner) trainMultipleSpinner.style.display = 'none'; trainMultipleBtn.disabled = false; }); }); }
}); // Fim DOMContentLoaded
</script>
{% endblock extra_scripts %}